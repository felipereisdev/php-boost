#!/usr/bin/env php
<?php

if (file_exists(__DIR__ . '/../../../autoload.php')) {
    require __DIR__ . '/../../../autoload.php';
} elseif (file_exists(__DIR__ . '/../vendor/autoload.php')) {
    require __DIR__ . '/../vendor/autoload.php';
} else {
    die('Autoloader not found. Run: composer install' . PHP_EOL);
}

use FelipeReisDev\PhpBoost\Standalone\Bootstrap;

$projectPath = getenv('PHP_BOOST_PROJECT_PATH') ?: getcwd();

for ($i = 1; $i < count($argv); $i++) {
    $arg = $argv[$i];

    if ($arg === '--help' || $arg === '-h') {
        echo "PHP Boost MCP Server\n";
        echo "Usage: boost-server [--project=/path/to/php-project]\n";
        echo "Options:\n";
        echo "  --project, -p   PHP project root path (defaults to current directory)\n";
        echo "  --help, -h      Show this help\n";
        exit(0);
    }

    if (strpos($arg, '--project=') === 0) {
        $projectPath = substr($arg, 10);
        continue;
    }

    if ($arg === '--project' || $arg === '-p') {
        if (isset($argv[$i + 1])) {
            $projectPath = $argv[$i + 1];
            $i++;
        }
    }
}

$projectPath = rtrim($projectPath, '/');

if (!is_dir($projectPath)) {
    fwrite(STDERR, "Project path not found: {$projectPath}" . PHP_EOL);
    exit(1);
}

if (!@chdir($projectPath)) {
    fwrite(STDERR, "Unable to change working directory to: {$projectPath}" . PHP_EOL);
    exit(1);
}

putenv("PHP_BOOST_PROJECT_PATH={$projectPath}");

$envPath = $projectPath . '/.env';
if (file_exists($envPath)) {
    $lines = file($envPath, FILE_IGNORE_NEW_LINES | FILE_SKIP_EMPTY_LINES);
    foreach ($lines as $line) {
        if (strpos($line, '=') !== false && strpos($line, '#') !== 0) {
            list($key, $value) = explode('=', $line, 2);
            $key = trim($key);
            $value = trim($value);
            $value = trim($value, '"\'');
            putenv("{$key}={$value}");
        }
    }
}

$bootstrap = Bootstrap::fromEnv($projectPath);
$bootstrap->start();

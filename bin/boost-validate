#!/usr/bin/env php
<?php

if (file_exists(__DIR__ . '/../../../autoload.php')) {
    require __DIR__ . '/../../../autoload.php';
} elseif (file_exists(__DIR__ . '/../vendor/autoload.php')) {
    require __DIR__ . '/../vendor/autoload.php';
} else {
    die('Autoloader not found. Run: composer install' . PHP_EOL);
}

use FelipeReisDev\PhpBoost\Core\Tools\ProjectInspector;
use FelipeReisDev\PhpBoost\Core\Services\GuidelineValidator;

$rootPath = getcwd();
$format = 'text';
$outputFile = null;

foreach ($argv as $arg) {
    if (strpos($arg, '--path=') === 0) {
        $rootPath = substr($arg, 7);
    } elseif (strpos($arg, '--format=') === 0) {
        $format = substr($arg, 9);
    } elseif (strpos($arg, '--output=') === 0) {
        $outputFile = substr($arg, 9);
    } elseif ($arg === '--help' || $arg === '-h') {
        displayHelp();
        exit(0);
    }
}

$composerPath = $rootPath . '/composer.json';

if (!file_exists($composerPath)) {
    echo "Error: composer.json not found at {$composerPath}\n";
    exit(1);
}

echo "PHP Boost - Guideline Validation\n";
echo "=================================\n\n";

echo "Inspecting project...\n";
$inspector = new ProjectInspector($rootPath, $composerPath);
$projectInfo = $inspector->inspect();

echo "Validating guidelines...\n\n";
$validator = new GuidelineValidator($rootPath, $projectInfo);
$results = $validator->validate();

$output = formatOutput($results, $format);

if ($outputFile) {
    file_put_contents($outputFile, $output);
    echo "Results written to: {$outputFile}\n";
} else {
    echo $output;
}

$exitCode = $results['score'] >= 70 ? 0 : 1;
exit($exitCode);

function formatOutput($results, $format)
{
    switch ($format) {
        case 'json':
            return json_encode($results, JSON_PRETTY_PRINT);
        
        case 'markdown':
            return formatMarkdown($results);
        
        case 'text':
        default:
            return formatText($results);
    }
}

function formatText($results)
{
    $output = '';
    
    $output .= "Overall Score: {$results['score']}/{$results['max_score']}\n\n";
    
    if ($results['score'] >= 90) {
        $output .= "✓ Excellent - Project follows guidelines\n\n";
    } elseif ($results['score'] >= 70) {
        $output .= "⚠ Good - Minor improvements needed\n\n";
    } elseif ($results['score'] >= 50) {
        $output .= "⚠ Fair - Several issues to address\n\n";
    } else {
        $output .= "✗ Poor - Immediate attention required\n\n";
    }
    
    foreach ($results['results'] as $category => $result) {
        $categoryName = str_replace('_', ' ', ucwords($category, '_'));
        $output .= "{$categoryName}: {$result['score']}/{$result['max_score']}\n";
        
        if (!empty($result['issues'])) {
            foreach ($result['issues'] as $issue) {
                $output .= "  - {$issue}\n";
            }
        }
        
        $output .= "\n";
    }
    
    if (!empty($results['recommendations'])) {
        $output .= "Recommendations:\n";
        
        foreach ($results['recommendations'] as $i => $recommendation) {
            $output .= ($i + 1) . ". {$recommendation}\n";
        }
        
        $output .= "\n";
    }
    
    return $output;
}

function formatMarkdown($results)
{
    $output = "# Guideline Validation Report\n\n";
    
    $output .= "## Overall Score: {$results['score']}/{$results['max_score']}\n\n";
    
    if ($results['score'] >= 90) {
        $output .= "✓ **Excellent** - Project follows guidelines\n\n";
    } elseif ($results['score'] >= 70) {
        $output .= "⚠ **Good** - Minor improvements needed\n\n";
    } elseif ($results['score'] >= 50) {
        $output .= "⚠ **Fair** - Several issues to address\n\n";
    } else {
        $output .= "✗ **Poor** - Immediate attention required\n\n";
    }
    
    $output .= "## Category Scores\n\n";
    
    foreach ($results['results'] as $category => $result) {
        $categoryName = str_replace('_', ' ', ucwords($category, '_'));
        $output .= "### {$categoryName}: {$result['score']}/{$result['max_score']}\n\n";
        
        if (!empty($result['issues'])) {
            foreach ($result['issues'] as $issue) {
                $output .= "- {$issue}\n";
            }
            $output .= "\n";
        }
    }
    
    if (!empty($results['recommendations'])) {
        $output .= "## Recommendations\n\n";
        
        foreach ($results['recommendations'] as $i => $recommendation) {
            $output .= ($i + 1) . ". {$recommendation}\n";
        }
        
        $output .= "\n";
    }
    
    return $output;
}

function displayHelp()
{
    echo <<<'HELP'
PHP Boost - Guideline Validation

Validate project code against PHP Boost guidelines.

Usage:
  ./vendor/bin/boost-validate [options]

Options:
  --path=<path>        Project root path (default: current directory)
  --format=<format>    Output format: text, json, markdown (default: text)
  --output=<file>      Write output to file instead of stdout
  -h, --help           Display this help message

Examples:
  ./vendor/bin/boost-validate
  ./vendor/bin/boost-validate --format=json
  ./vendor/bin/boost-validate --format=markdown --output=report.md
  ./vendor/bin/boost-validate --path=/path/to/project

Exit Codes:
  0 - Score >= 70 (passing)
  1 - Score < 70 (failing)

HELP;
}
